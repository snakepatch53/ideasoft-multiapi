name: ğŸš€ Build and Deploy

on:
    push:
        branches:
            - main

env:
    PM2_NAME: 'ideasoft-multiapi'
    APP_DOMAIN: 'https://api.ideasoft.site'
    SERVER_DIR: '/home/ideasoft/projects/ideasoft-multiapi'

concurrency:
    group: deploy
    cancel-in-progress: false

jobs:
    deploy:
        runs-on: ubuntu-latest

        steps:
            - name: ğŸ” Deploy via SSH
              uses: appleboy/ssh-action@v0.1.10
              with:
                  host: ${{ secrets.SSH_HOST }}
                  username: ${{ secrets.SSH_USER }}
                  password: ${{ secrets.SSH_PASS }}
                  script: |
                      echo "ğŸ“¦ Entrando al servidor..."
                      cd ${{ env.SERVER_DIR }}

                      echo "ğŸŒ€ Actualizando cÃ³digo..."
                      git fetch origin main
                      git reset --hard origin/main

                      echo "ğŸ“¦ Instalando dependencias..."
                      npm install --legacy-peer-deps

                      echo "âš™ï¸ Compilando proyecto..."
                      npm run build

                      echo "ğŸ§© Generando archivo .env dentro del build..."
                      cp .env.example build/.env
                      echo "APP_URL=${{ env.APP_DOMAIN }}" >> build/.env
                      echo "DB_DATABASE=${{ secrets.DB_NAME }}" >> build/.env
                      echo "DB_USERNAME=${{ secrets.DB_USER }}" >> build/.env
                      echo "DB_PASSWORD=${{ secrets.DB_PASS }}" >> build/.env

                      echo "ğŸ§± Generando key si no existe..."
                      node ace generate:key

                      echo "â™»ï¸ Reiniciando PM2..."
                      pm2 restart ${{ env.PM2_NAME }} || pm2 start "node build/server.js" --name "${{ env.PM2_NAME }}"
