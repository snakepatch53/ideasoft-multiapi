name: üöÄ Build and Deploy

on:
    push:
        branches:
            - main

env:
    PM2_NAME: 'ideasoft-multiapi'
    APP_DOMAIN: 'https://api.ideasoft.site'
    SERVER_DIR: '/home/ideasoft/projects/ideasoft-multiapi'

concurrency:
    group: deploy
    cancel-in-progress: false

jobs:
    deploy:
        runs-on: ubuntu-latest

        steps:
            - name: üîê Deploy via SSH
              uses: appleboy/ssh-action@v0.1.10
              with:
                  host: ${{ secrets.SSH_HOST }}
                  username: ${{ secrets.SSH_USER }}
                  password: ${{ secrets.SSH_PASS }}
                  script: |
                      # --- Cargar entorno Node (importante) ---
                      export NVM_DIR="$HOME/.nvm"
                      [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
                      export PATH=$PATH:/usr/local/bin:/usr/bin:/bin:/home/ideasoft/.npm-global/bin

                      echo "üì¶ Entrando al servidor..."
                      cd ${{ env.SERVER_DIR }}

                      echo "üåÄ Actualizando c√≥digo..."
                      git fetch origin main
                      git reset --hard origin/main

                      echo "üì¶ Instalando dependencias..."
                      npm install --legacy-peer-deps

                      echo "‚öôÔ∏è Compilando proyecto..."
                      npm run build

                      echo "üß© Generando archivo .env dentro del build..."
                      cp .env.example build/.env
                      echo -e "\n" >> build/.env
                      echo "APP_URL=${{ env.APP_DOMAIN }}" >> build/.env
                      echo "PORT=8081" >> build/.env
                      echo "DB_DATABASE=${{ secrets.DB_NAME }}" >> build/.env
                      echo "DB_USER=${{ secrets.DB_USER }}" >> build/.env
                      echo "DB_PASSWORD=${{ secrets.DB_PASS }}" >> build/.env

                      echo "üß± Generando key si no existe..."
                      cd build
                      node ace generate:key
                      cd ..

                      echo "‚ôªÔ∏è Reiniciando PM2..."
                      pm2 restart ${{ env.PM2_NAME }} || pm2 start "node build/server.js" --name "${{ env.PM2_NAME }}"
